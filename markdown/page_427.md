
#### 12.2.2.3 AMS Sketch

As discussed at the beginning of this section, different synopsis structures are designed for different kinds of queries. While the bloom filter and count-min sketch provide good estimations of various queries, some queries, such as second moments, can be better addressed with the Alon-Matias-Szegedy (AMS) sketch. In the AMS sketch, a random binary value is generated from $\{-1, 1\}$ for each stream element by applying a hash function to the stream element. These binary values are assumed to be 4-wise independent. This means that, if at most four values generated from the same hash function are sampled, they will be statistically independent of one another. It is easier to design a 4-wise independent hash function than a fully independent hash function. The details of 4-wise independent hash functions may be found in the bibliographic notes.

Consider a stream in which the $i$-th stream element is associated with the _aggregate frequency_ $f_i$. The second-order moment $F_2$ of the data stream, for a stream with $n$ _distinct elements_, is defined as follows:

$$
F_2 = \sum_{i=1}^{n} f_i^2
$$

In the massive-domain scenario, where the number of distinct elements is large, this quantity is hard to estimate because running counts of the frequencies $f_i$ cannot be maintained with an array. However, it can be estimated effectively using the AMS sketch. As a practical application, the second-order moment yields an estimate of the self-join size of a data stream with respect to the massive-domain attribute. The second-order moment can also be viewed as a variant of the Gini index, which measures the level of frequency skew over different items in the data stream. When the skew is large, the value of $F_2$ is large, and very close to its upper bound $(\sum_{i=1}^{n} f_i)^2$.

The AMS sketch contains $m$ different sketch components, each of which is associated with an independent hash function. Each hash function generates its corresponding sketch component as follows. A random binary value, with equal probability for both realizations, is generated for the incoming stream element. This binary value is denoted by $r \in \{-1, 1\}$, and is generated using the hash function for that component. The frequency of each incoming stream element is multiplied by $r$, and added to the corresponding component of the sketch. Let $r_i \in \{-1, 1\}$ be the random value generated by a particular hash function for the $i$-th distinct element. Then, the corresponding component $Q$ of the sketch, for a stream of $n$ distinct elements with aggregate frequencies $f_1 \ldots f_n$, can be shown to be equal to the following:

$$
Q = \sum_{i=1}^{n} f_i \cdot r_i
$$

This relationship is because of the incremental way in which $Q$ is updated, each time a stream item is received. Note that the value of $Q$ is a random variable, dependent on how the binary random values $r_1 \ldots r_n$ are generated by the hash function. The value of $Q$ is useful in estimating the second moment.

##### Lemma 12.2.2.4 The second moment of the data stream can be estimated by the square of the AMS sketch component $Q$:

$$
F_2 = E[Q^2].
$$

_Proof_: It is easy to see that $Q^2 = \sum_{i=1}^{n} f_i^2 r_i^2 + 2 \sum_{i=1}^{n} \sum_{j=i+1}^{n} f_i \cdot f_j \cdot r_i \cdot r_j$. For any pair of hash values $r_i, r_j$, we have $r_i^2 = r_j^2 = 1$ and $E[r_i \cdot r_j] = E[r_i] \cdot E[r_j] = 0$. The last of
