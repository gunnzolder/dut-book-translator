#### 12.2.2.3 Нарис AMS

Як обговорювалося на початку цього розділу, різні структури синопсису призначені для різних видів запитів. Хоча блум-фільтр та скетч count-min забезпечують хорошу оцінку різних запитів, деякі запити, такі як другі моменти, можуть бути краще вирішені за допомогою скетчу Алона-Матіаса-Сегеді (AMS). У скетчі AMS для кожного елемента потоку генерується випадкове бінарне значення з {-1, 1} шляхом застосування хеш-функції до елемента потоку. Вважається, що ці бінарні значення є 4-незалежними. Це означає, що якщо вибрати не більше чотирьох значень, згенерованих однією і тією ж хеш-функцією, вони будуть статистично незалежними одне від одного. Розробити 4-незалежну хеш-функцію простіше, ніж повністю незалежну хеш-функцію. Деталі 4-незалежних хеш-функцій можна знайти в бібліографічних нотатках.

Розглянемо потік, в якому i-й елемент потоку асоціюється з _агрегованою частотою_ $f_i$. Другий момент $F_2$ потоку даних для потоку з $n$ _різними елементами_ визначається наступним чином:

$$
F_2 = \sum_{i=1}^{n} f_i^2
$$

У сценарії масивного домену, де кількість різних елементів велика, це значення важко оцінити, оскільки підрахунок частот $f_i$ не можна підтримувати за допомогою масиву. Однак його можна ефективно оцінити за допомогою скетчу AMS. Як практичне застосування, другий момент дає оцінку розміру самоз'єднання потоку даних щодо атрибута масивного домену. Другий момент також можна розглядати як варіант індексу Джині, який вимірює рівень нахилу частоти для різних елементів у потоці даних. Коли нахил великий, значення $F_2$ велике і дуже близьке до його верхньої межі $(\sum_{i=1}^{n} f_i)^2$.

Скетч AMS містить $m$ різних компонентів скетчу, кожен з яких асоціюється з незалежною хеш-функцією. Кожна хеш-функція генерує відповідний компонент скетчу наступним чином. Для вхідного елемента потоку генерується випадкове бінарне значення з рівною ймовірністю для обох реалізацій. Це бінарне значення позначається як $r \in \{-1, 1\}$ і генерується за допомогою хеш-функції для цього компонента. Частота кожного вхідного елемента потоку множиться на $r$ і додається до відповідного компонента скетчу. Нехай $r_i \in \{-1, 1\}$ - випадкове значення, згенероване певною хеш-функцією для i-го різного елемента. Тоді відповідний компонент $Q$ скетчу для потоку з $n$ різними елементами з агрегованими частотами $f_1 \ldots f_n$ можна показати рівним наступному:

$$
Q = \sum_{i=1}^{n} f_i \cdot r_i
$$

Це співвідношення обумовлене інкрементним способом оновлення $Q$ кожного разу, коли надходить елемент потоку. Зверніть увагу, що значення $Q$ є випадковою величиною, яка залежить від того, як бінарні випадкові значення $r_1 \ldots r_n$ генеруються хеш-функцією. Значення $Q$ корисне для оцінки другого моменту.

##### Лема 12.2.2.4 Другий момент потоку даних можна оцінити за квадратом компонента скетчу AMS $Q$:

$$
F_2 = E[Q^2].
$$

_Доведення_: Легко побачити, що $Q^2 = \sum_{i=1}^{n} f_i^2 r_i^2 + 2 \sum_{i=1}^{n} \sum_{j=i+1}^{n} f_i \cdot f_j \cdot r_i \cdot r_j$. Для будь-якої пари хеш-значень $r_i, r_j$ маємо $r_i^2 = r_j^2 = 1$ і $E[r_i \cdot r_j] = E[r_i] \cdot E[r_j] = 0$. Останнє з